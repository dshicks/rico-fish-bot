<script>
  const chatBox = document.getElementById('chat-box');
  const chatForm = document.getElementById('chat-form');
  const userInput = document.getElementById('user-input');

  // ‚úÖ Replace with your OpenWeatherMap API key
  const WEATHER_API_KEY = "1e24ea016ffb7aaf0846b9dd682a2698";

  // =========================
  // NOAA CO-OPS (Tides)
  // =========================
  // Rockport, TX (near Redfish Bay) tide station
  const NOAA_STATION = "8774770";
  const NOAA_DATUM = "MLLW";     // mean lower low water (common for anglers)
  const NOAA_UNITS = "english";  // feet
  const NOAA_TZ = "lst_ldt";     // local time w/ DST
  const NOAA_PRODUCT = "predictions";
  const NOAA_INTERVAL = "hilo";  // just high/low events

  // Helpers
  const yyyymmdd = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}${m}${day}`;
  };

  // ‚úÖ Fetch NOAA tide data for ~24h window (today -> tomorrow), summarized for chat
  async function getTideData() {
    const today = new Date();
    const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);

    const url =
      `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?` +
      `station=${NOAA_STATION}&product=${NOAA_PRODUCT}&datum=${NOAA_DATUM}` +
      `&units=${NOAA_UNITS}&time_zone=${NOAA_TZ}&format=json&interval=${NOAA_INTERVAL}` +
      `&begin_date=${yyyymmdd(today)}&end_date=${yyyymmdd(tomorrow)}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`NOAA error ${res.status}`);
    const data = await res.json();
    const preds = data?.predictions || [];

    if (!preds.length) return "Tide data unavailable.";

    // Build a compact summary like: "High 6:12 AM 1.85ft; Low 12:47 PM 0.12ft; ..."
    const summary = preds.slice(0, 4).map(p => {
      const dt = new Date(p.t);
      const hhmm = dt.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      const label = p.type === 'H' ? 'High' : 'Low';
      const height = Number.parseFloat(p.v).toFixed(2);
      return `${label} ${hhmm} ${height}ft`;
    }).join('; ');

    return `${summary} (NOAA ${NOAA_STATION} ${NOAA_DATUM})`;
  }

  // =========================
  // OpenWeather: real-time weather for Rockport, TX
  // =========================
  async function getWeatherData() {
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=28.0206&lon=-97.0544&appid=${WEATHER_API_KEY}&units=imperial`;
    const res = await fetch(url);
    const data = await res.json();

    console.log("Weather API response:", data); // Debug in browser console

    if (data.cod !== 200 || !data.main) {
      return "Weather data unavailable.";
    }

    const temp = data.main.temp ?? "N/A";
    const feelsLike = data.main.feels_like ?? "N/A";
    const humidity = data.main.humidity ?? "N/A";
    const windSpeed = data.wind.speed ?? "N/A";
    const condition = data.weather[0]?.description ?? "N/A";

    return `Temp: ${temp}¬∞F (Feels like ${feelsLike}¬∞F), Humidity: ${humidity}%, Wind: ${windSpeed} mph, Conditions: ${condition}`;
  }

  // =========================
  // Chat logic (Weather + Tide)
  // =========================
  chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const message = userInput.value.trim();
    if (!message) return;

    appendMessage("You", message, "user-msg");
    userInput.value = "";
    appendMessage("Rico Fish Bot", "üå§ Fetching weather and üåä tide data...", "bot-msg");

    try {
      // Fetch both in parallel
      const [weatherInfo, tideInfo] = await Promise.all([
        getWeatherData(),
        getTideData()
      ]);

      appendMessage("Rico Fish Bot", "‚úÖ Data loaded. Thinking...", "bot-msg");

      const response = await fetch("https://rico-fish-bot-backend.onrender.com/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `${message} (Weather: ${weatherInfo}) (Tide: ${tideInfo})`
        })
      });

      const data = await response.json();
      const reply = data?.choices?.[0]?.message?.content || "‚ö†Ô∏è No response from server.";
      updateLastBotMessage(reply);
    } catch (error) {
      console.error(error);
      updateLastBotMessage("‚ö†Ô∏è Error fetching weather/tide or connecting to backend.");
    }
  });

  function appendMessage(sender, text, className) {
    const msg = document.createElement('p');
    msg.className = className;
    msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function updateLastBotMessage(text) {
    const botMessages = chatBox.querySelectorAll("p.bot-msg");
    if (botMessages.length > 0) {
      botMessages[botMessages.length - 1].innerHTML = `<strong>Rico Fish Bot:</strong> ${text}`;
    }
  }
</script>
