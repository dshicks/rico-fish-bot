<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rico Fish Bot</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f8ff;
      margin: 0;
      color: #222;
    }

    header {
      position: relative;
      background: url('sunrise-over-redfish-bay.jpg') center/cover no-repeat;
      padding: 80px 20px;
      text-align: center;
      color: #fff;
    }

    header::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.4); /* Semi-transparent overlay for contrast */
    }

    header h1,
    header p {
      position: relative; /* So text stays above overlay */
      text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.7);
    }

    header h1 {
      font-size: 3em;
      font-weight: 700;
      margin-bottom: 10px;
    }

    header p {
      font-size: 1.6em;
      font-weight: 400;
      margin-bottom: 20px;
    }

    section { padding: 40px 20px; max-width: 800px; margin: auto; }
    #chat-box p { padding: 8px; border-radius: 6px; margin: 5px 0; }
    .user-msg { background: #d1e7ff; text-align: right; }
    .bot-msg { background: #e6f7ff; text-align: left; }
    input, button { font-size: 1em; }
  </style>
</head>
<body>
  <header>
    <h1>Rico Fish Bot - A Subscription Service</h1>
    <p>Your AI Fishing Guide for Rockport, TX</p>
  </header>

  <section>
    <h2>üé£ Chat with Rico Fish Bot</h2>
    <div id="chat-box" style="background:#f9f9f9; border:1px solid #ccc; padding:15px; border-radius:10px; max-height:300px; overflow-y:auto;"></div>
    <form id="chat-form" style="margin-top:10px;">
      <input type="text" id="user-input" value="I want to fish tomorrow at 6:00AM" style="width:75%; padding:10px;" />
      <button type="submit" style="padding:10px;">Send</button>
    </form>
  </section>

  <script>
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    // ‚úÖ Weather API key
    const WEATHER_API_KEY = "1e24ea016ffb7aaf0846b9dd682a2698";

    // ‚úÖ NOAA Tide settings
    const NOAA_STATION = "8774770"; // Rockport, TX
    const NOAA_DATUM = "MLLW";
    const NOAA_UNITS = "english";
    const NOAA_TZ = "lst_ldt";
    const NOAA_PRODUCT = "predictions";
    const NOAA_INTERVAL = "hilo";

    function yyyymmdd(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}${m}${d}`;
    }

    // ‚úÖ Fetch NOAA tide data
    async function getTideData() {
      const today = new Date();
      const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
      const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?station=${NOAA_STATION}&product=${NOAA_PRODUCT}&datum=${NOAA_DATUM}&units=${NOAA_UNITS}&time_zone=${NOAA_TZ}&format=json&interval=${NOAA_INTERVAL}&begin_date=${yyyymmdd(today)}&end_date=${yyyymmdd(tomorrow)}`;
      const res = await fetch(url);
      const data = await res.json();
      const preds = data?.predictions || [];
      if (!preds.length) return "Tide data unavailable.";
      return preds.slice(0, 4).map(p => {
        const dt = new Date(p.t);
        const time = dt.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        const type = p.type === "H" ? "High" : "Low";
        return `${type} ${time} ${parseFloat(p.v).toFixed(2)}ft`;
      }).join("; ");
    }

    // ‚úÖ Fetch weather data
    async function getWeatherData() {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=28.0206&lon=-97.0544&appid=${WEATHER_API_KEY}&units=imperial`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.cod !== 200 || !data.main) return "Weather data unavailable.";
      return `Temp: ${data.main.temp}¬∞F, Humidity: ${data.main.humidity}%, Wind: ${data.wind.speed} mph, Conditions: ${data.weather[0]?.description}`;
    }

    // ‚úÖ Chat logic
    chatForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const message = userInput.value.trim();
      if (!message) return;

      appendMessage("You", message, "user-msg");
      userInput.value = "";
      appendMessage("Rico Fish Bot", "Fetching weather and tide data...", "bot-msg");

      try {
        const [weatherInfo, tideInfo] = await Promise.all([getWeatherData(), getTideData()]);
        appendMessage("Rico Fish Bot", "Data loaded. Thinking...", "bot-msg");

        const response = await fetch("https://rico-fish-bot-backend.onrender.com/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: `${message} (Weather: ${weatherInfo}) (Tide: ${tideInfo})` })
        });

        const data = await response.json();
        const reply = data?.choices?.[0]?.message?.content || "‚ö†Ô∏è No response from server.";
        updateLastBotMessage(reply);
      } catch (error) {
        console.error(error);
        updateLastBotMessage("‚ö†Ô∏è Error fetching data or connecting to backend.");
      }
    });

    function appendMessage(sender, text, className) {
      const msg = document.createElement('p');
      msg.className = className;
      msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updateLastBotMessage(text) {
      const botMessages = chatBox.querySelectorAll("p.bot-msg");
      if (botMessages.length > 0) {
        botMessages[botMessages.length - 1].innerHTML = `<strong>Rico Fish Bot:</strong> ${text}`;
      }
    }
  </script>
</body>
</html>

