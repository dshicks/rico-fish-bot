<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fishing Map - Rico Fish Bot</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin: 0; font-family: 'Segoe UI', sans-serif; }
  #map { height: 100vh; width: 100%; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const BASE_URL = "https://rico-fish-bot-backend.onrender.com";

const map = L.map('map').setView([28.0, -97.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

async function loadMapLocations() {
  try {
    const res = await fetch(`${BASE_URL}/api/locations`);
    const locations = await res.json();

    locations.forEach(loc => {
      if (!loc.lat || !loc.lng) return;

      const marker = L.marker([loc.lat, loc.lng]).addTo(map);
      marker.bindPopup(`<b>${escapeHtml(loc.name)}</b><br>Loading tips...`);

      marker.on('click', async () => {
        try {
          const res = await fetch(`${BASE_URL}/api/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: `Give fishing tips for ${loc.name}` })
          });
          const data = await res.json();
          const tips = escapeHtml(data.llmReply || 'No tips available.');
          marker.setPopupContent(`<b>${escapeHtml(loc.name)}</b><br>${tips}`);
        } catch (err) {
          console.error('Failed to fetch tips:', err);
          marker.setPopupContent(`<b>${escapeHtml(loc.name)}</b><br>Error loading tips.`);
        }
      });
    });
  } catch (err) {
    console.error('Failed to load locations:', err);
  }
}

loadMapLocations();
</script>

</body>
</html>
